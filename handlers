from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from datetime import datetime
from sheets import add_to_google_sheet

CHOOSING, ADVERTISER_BRAND, ADVERTISER_NICHE, ADVERTISER_BUDGET, ADVERTISER_AUDIENCE = range(5)
BLOGGER = 5

ADMIN_CHAT_ID = 235130655  # –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π

# === –ö–æ–º–∞–Ω–¥–∞ /start ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["üî∏ –Ø —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å", "üîπ –Ø –±–ª–æ–≥–µ—Ä"]]
    markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    await update.message.reply_text("üëã –ü—Ä–∏–≤–µ—Ç! –ö—Ç–æ —Ç—ã?", reply_markup=markup)
    return CHOOSING

# === –í—ã–±–æ—Ä —Ä–æ–ª–∏ ===
async def choose_role(update: Update, context: ContextTypes.DEFAULT_TYPE):
    role = update.message.text
    if "—Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å" in role:
        await update.message.reply_text("1Ô∏è‚É£ –ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞:")
        return ADVERTISER_BRAND
    elif "–±–ª–æ–≥–µ—Ä" in role:
        await update.message.reply_text("–ó–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):\n\n1. –ò–º—è\n2. –°—Å—ã–ª–∫–∞ –Ω–∞ –±–ª–æ–≥\n3. –¢–µ–º–∞—Ç–∏–∫–∞\n4. –û—Ö–≤–∞—Ç\n5. –¶–µ–Ω–∞ –∑–∞ —Ä–µ–∫–ª–∞–º—É")
        return BLOGGER

# === –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å: –ø–æ —à–∞–≥–∞–º ===
async def advertiser_brand(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["brand"] = update.message.text
    await update.message.reply_text("2Ô∏è‚É£ –ù–∏—à–∞:")
    return ADVERTISER_NICHE

async def advertiser_niche(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["niche"] = update.message.text
    await update.message.reply_text("3Ô∏è‚É£ –ë—é–¥–∂–µ—Ç:")
    return ADVERTISER_BUDGET

async def advertiser_budget(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["budget"] = update.message.text
    await update.message.reply_text("4Ô∏è‚É£ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:")
    return ADVERTISER_AUDIENCE

async def advertiser_audience(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["audience"] = update.message.text
    user = update.message.from_user
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    data = [
        "–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å",
        user.first_name,
        f"@{user.username}",
        context.user_data["brand"],
        context.user_data["niche"],
        context.user_data["budget"],
        context.user_data["audience"],
        timestamp
    ]
    add_to_google_sheet(data, sheet_name="–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏")

    info = (
        f"\n=== –ó–∞—è–≤–∫–∞ –æ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è ===\n"
        f"–ò–º—è: {user.first_name} @{user.username}\n"
        f"–ë—Ä–µ–Ω–¥: {context.user_data['brand']}\n"
        f"–ù–∏—à–∞: {context.user_data['niche']}\n"
        f"–ë—é–¥–∂–µ—Ç: {context.user_data['budget']}\n"
        f"–¶–ê: {context.user_data['audience']}\n"
    )

    await context.bot.send_message(chat_id=ADMIN_CHAT_ID, text=f"üì© –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è:\n{info}")
    await update.message.reply_text("–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ —Å–∫–æ—Ä–æ. üôå")

    return ConversationHandler.END

# === –ë–ª–æ–≥–µ—Ä: –∞–Ω–∫–µ—Ç–∞ –≤ 1 —Å–æ–æ–±—â–µ–Ω–∏–∏ ===
async def save_blogger(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user = update.message.from_user
    fields = text.split("\n")

    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —á—Ç–æ–±—ã –Ω–µ —É–ø–∞–ª–æ, –µ—Å–ª–∏ –ø–æ–ª–µ–π –º–µ–Ω—å—à–µ
    while len(fields) < 5:
        fields.append("-")

    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    data = [
        "–ë–ª–æ–≥–µ—Ä",
        user.first_name,
        f"@{user.username}",
        fields[0],  # –ò–º—è
        fields[1],  # –°—Å—ã–ª–∫–∞
        fields[2],  # –¢–µ–º–∞—Ç–∏–∫–∞
        fields[3],  # –û—Ö–≤–∞—Ç
        fields[4],  # –¶–µ–Ω–∞
        timestamp
    ]
    add_to_google_sheet(data, sheet_name="–ë–ª–æ–≥–µ—Ä—ã")

    info = (
        f"\n=== –ê–Ω–∫–µ—Ç–∞ –±–ª–æ–≥–µ—Ä–∞ ===\n"
        f"–ò–º—è: {user.first_name} @{user.username}\n"
        f"{text}\n"
    )
    await context.bot.send_message(chat_id=ADMIN_CHAT_ID, text=f"üì© –ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞ –±–ª–æ–≥–µ—Ä–∞:\n{info}")
    await update.message.reply_text("–ê–Ω–∫–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞! –ú—ã –¥–æ–±–∞–≤–∏–º –≤–∞—Å –≤ –±–∞–∑—É ‚úÖ")

    return ConversationHandler.END

# === –û—Ç–º–µ–Ω–∞ ===
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–û–∫–µ–π, –æ—Ç–º–µ–Ω–∏–ª–∏ üòå")
    return ConversationHandler.END
